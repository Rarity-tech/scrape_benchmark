name: Debug Guest Favorite Filter

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: pip install curl_cffi
      
      - name: Test different filter parameters
        run: |
          python << 'EOF'
          import json
          from curl_cffi import requests as curl_requests

          AIRBNB_API_KEY = "d306zoyjsyarp7ifhu67rjxn52tv0t20"

          # Zone Downtown Dubai
          NE_LAT = 25.208047
          NE_LNG = 55.286305
          SW_LAT = 25.181020
          SW_LNG = 55.256437

          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              "Accept": "application/json",
              "X-Airbnb-API-Key": AIRBNB_API_KEY,
          }

          # Test diffÃ©rents paramÃ¨tres pour Guest Favorite
          test_params = [
              {"name": "selected_filter_order[]", "value": "guest_favorite"},
              {"name": "refinement_paths[]", "value": "/homes/guest_favorites"},
              {"name": "search_mode", "value": "guest_favorite"},
              {"name": "filter_by_guest_favorite", "value": "true"},
              {"name": "guest_favorite", "value": "true"},
              {"name": "is_guest_favorite", "value": "true"},
              {"name": "collection_ids[]", "value": "1"},  # Possible ID for Guest Favorites
          ]

          base_params = {
              "checkin": "2025-02-01",
              "checkout": "2025-02-05",
              "ne_lat": str(NE_LAT),
              "ne_lng": str(NE_LNG),
              "sw_lat": str(SW_LAT),
              "sw_lng": str(SW_LNG),
              "search_by_map": "true",
              "zoom": "14",
              "version": "1.8.3",
              "_format": "for_explore_search_web",
              "items_per_grid": "20",
              "currency": "AED",
              "locale": "en",
              "key": AIRBNB_API_KEY,
              "refinement_paths[]": "/homes",
              "tab_id": "home_tab",
          }

          print("=" * 80)
          print("ğŸ” TEST DES PARAMÃˆTRES GUEST FAVORITE")
          print("=" * 80)

          # D'abord, test SANS filtre pour avoir une baseline
          print("\nğŸ“Š TEST 0: SANS FILTRE (baseline)")
          print("-" * 40)
          
          try:
              response = curl_requests.get(
                  "https://www.airbnb.com/api/v2/explore_tabs",
                  params=base_params,
                  headers=headers,
                  impersonate="chrome120",
                  timeout=30
              )
              
              if response.status_code == 200:
                  data = response.json()
                  count = 0
                  for tab in data.get("explore_tabs", []):
                      for section in tab.get("sections", []):
                          count += len(section.get("listings", []))
                  print(f"   âœ… {count} listings trouvÃ©s")
              else:
                  print(f"   âŒ HTTP {response.status_code}")
          except Exception as e:
              print(f"   âŒ Erreur: {e}")

          # Test chaque paramÃ¨tre
          for i, test in enumerate(test_params, 1):
              print(f"\nğŸ“Š TEST {i}: {test['name']}={test['value']}")
              print("-" * 40)
              
              params = base_params.copy()
              params[test['name']] = test['value']
              
              try:
                  response = curl_requests.get(
                      "https://www.airbnb.com/api/v2/explore_tabs",
                      params=params,
                      headers=headers,
                      impersonate="chrome120",
                      timeout=30
                  )
                  
                  if response.status_code == 200:
                      data = response.json()
                      count = 0
                      guest_fav_count = 0
                      
                      for tab in data.get("explore_tabs", []):
                          for section in tab.get("sections", []):
                              for listing in section.get("listings", []):
                                  count += 1
                                  listing_data = listing.get("listing", {})
                                  # VÃ©rifier si c'est un guest favorite
                                  if listing_data.get("is_guest_favorite") or listing_data.get("guest_favorite"):
                                      guest_fav_count += 1
                      
                      print(f"   âœ… {count} listings trouvÃ©s")
                      print(f"   â­ {guest_fav_count} Guest Favorites dÃ©tectÃ©s")
                      
                      # Si moins de rÃ©sultats que baseline, c'est peut-Ãªtre le bon filtre
                      if count < 20 and count > 0:
                          print(f"   ğŸ¯ POSSIBLE BON FILTRE!")
                  else:
                      print(f"   âŒ HTTP {response.status_code}")
                      # Afficher un peu de la rÃ©ponse pour debug
                      print(f"   Response: {response.text[:200]}")
              except Exception as e:
                  print(f"   âŒ Erreur: {e}")

          # Test avec refinement_paths spÃ©cial
          print(f"\nğŸ“Š TEST SPECIAL: refinement_paths=/homes + guest_favorites filter")
          print("-" * 40)
          
          params = base_params.copy()
          params["refinement_paths[]"] = "/homes"
          params["selected_filter_order[]"] = "guest_favorites"  # avec 's'
          
          try:
              response = curl_requests.get(
                  "https://www.airbnb.com/api/v2/explore_tabs",
                  params=params,
                  headers=headers,
                  impersonate="chrome120",
                  timeout=30
              )
              
              if response.status_code == 200:
                  data = response.json()
                  count = 0
                  for tab in data.get("explore_tabs", []):
                      for section in tab.get("sections", []):
                          count += len(section.get("listings", []))
                  print(f"   âœ… {count} listings trouvÃ©s")
              else:
                  print(f"   âŒ HTTP {response.status_code}")
          except Exception as e:
              print(f"   âŒ Erreur: {e}")

          print("\n" + "=" * 80)
          print("ğŸ‰ FIN DES TESTS")
          print("=" * 80)
          EOF
