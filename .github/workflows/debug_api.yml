name: Debug Guest Favorite Filter V2

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: pip install curl_cffi
      
      - name: Test GraphQL and other endpoints
        run: |
          python << 'EOF'
          import json
          from curl_cffi import requests as curl_requests
          from urllib.parse import urlencode

          AIRBNB_API_KEY = "d306zoyjsyarp7ifhu67rjxn52tv0t20"

          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
              "Accept": "application/json",
              "Accept-Language": "en-US,en;q=0.9",
              "X-Airbnb-API-Key": AIRBNB_API_KEY,
              "Content-Type": "application/json",
          }

          print("=" * 80)
          print("ðŸ” TEST GUEST FAVORITES FILTER V2")
          print("=" * 80)

          # Test 1: explore_tabs avec diffÃ©rents paramÃ¨tres
          print("\nðŸ“Š TEST 1: explore_tabs avec quality_tier")
          print("-" * 40)
          
          params = {
              "checkin": "2025-02-15",
              "checkout": "2025-02-20",
              "ne_lat": "25.21",
              "ne_lng": "55.29",
              "sw_lat": "25.18",
              "sw_lng": "55.26",
              "search_by_map": "true",
              "zoom": "14",
              "version": "1.8.3",
              "_format": "for_explore_search_web",
              "items_per_grid": "20",
              "currency": "AED",
              "locale": "en",
              "key": AIRBNB_API_KEY,
              "refinement_paths[]": "/homes",
              "tab_id": "home_tab",
              "quality_tier": "guest_favorite",  # Possible parameter
          }
          
          try:
              response = curl_requests.get(
                  "https://www.airbnb.com/api/v2/explore_tabs",
                  params=params,
                  headers=headers,
                  impersonate="chrome120",
                  timeout=30
              )
              print(f"   Status: {response.status_code}")
              if response.status_code == 200:
                  data = response.json()
                  count = sum(len(s.get("listings", [])) for t in data.get("explore_tabs", []) for s in t.get("sections", []))
                  print(f"   RÃ©sultats: {count}")
          except Exception as e:
              print(f"   Erreur: {e}")

          # Test 2: Avec home_tier
          print("\nðŸ“Š TEST 2: explore_tabs avec home_tier=1")
          print("-" * 40)
          
          params["home_tier"] = "1"
          del params["quality_tier"]
          
          try:
              response = curl_requests.get(
                  "https://www.airbnb.com/api/v2/explore_tabs",
                  params=params,
                  headers=headers,
                  impersonate="chrome120",
                  timeout=30
              )
              print(f"   Status: {response.status_code}")
              if response.status_code == 200:
                  data = response.json()
                  count = sum(len(s.get("listings", [])) for t in data.get("explore_tabs", []) for s in t.get("sections", []))
                  print(f"   RÃ©sultats: {count}")
          except Exception as e:
              print(f"   Erreur: {e}")

          # Test 3: Avec min_tier
          print("\nðŸ“Š TEST 3: explore_tabs avec min_tier=1 (Guest Favorites tier)")
          print("-" * 40)
          
          params["min_tier"] = "1"
          del params["home_tier"]
          
          try:
              response = curl_requests.get(
                  "https://www.airbnb.com/api/v2/explore_tabs",
                  params=params,
                  headers=headers,
                  impersonate="chrome120",
                  timeout=30
              )
              print(f"   Status: {response.status_code}")
              if response.status_code == 200:
                  data = response.json()
                  count = sum(len(s.get("listings", [])) for t in data.get("explore_tabs", []) for s in t.get("sections", []))
                  print(f"   RÃ©sultats: {count}")
          except Exception as e:
              print(f"   Erreur: {e}")

          # Test 4: StaysSearch GraphQL endpoint
          print("\nðŸ“Š TEST 4: GraphQL StaysSearch avec guestFavorites filter")
          print("-" * 40)
          
          graphql_query = {
              "operationName": "StaysSearch",
              "variables": {
                  "request": {
                      "metadataOnly": False,
                      "searchType": "filter_change",
                      "treatmentFlags": [],
                      "rawParams": [
                          {"filterName": "cdnCacheSafe", "filterValues": ["false"]},
                          {"filterName": "checkin", "filterValues": ["2025-02-15"]},
                          {"filterName": "checkout", "filterValues": ["2025-02-20"]},
                          {"filterName": "ne_lat", "filterValues": ["25.21"]},
                          {"filterName": "ne_lng", "filterValues": ["55.29"]},
                          {"filterName": "sw_lat", "filterValues": ["25.18"]},
                          {"filterName": "sw_lng", "filterValues": ["55.26"]},
                          {"filterName": "zoom", "filterValues": ["14"]},
                          {"filterName": "search_by_map", "filterValues": ["true"]},
                          {"filterName": "selected_filter_order", "filterValues": ["guest_favorites"]},
                      ],
                  }
              },
              "extensions": {
                  "persistedQuery": {
                      "version": 1,
                      "sha256Hash": "placeholder"
                  }
              }
          }
          
          try:
              response = curl_requests.post(
                  "https://www.airbnb.com/api/v3/StaysSearch",
                  headers=headers,
                  json=graphql_query,
                  impersonate="chrome120",
                  timeout=30
              )
              print(f"   Status: {response.status_code}")
              if response.status_code == 200:
                  print(f"   Response preview: {response.text[:500]}")
              else:
                  print(f"   Response: {response.text[:300]}")
          except Exception as e:
              print(f"   Erreur: {e}")

          # Test 5: Essayer l'endpoint de recherche avec category_tag
          print("\nðŸ“Š TEST 5: explore_tabs avec category_tag=Tag:8661")
          print("-" * 40)
          
          params = {
              "checkin": "2025-02-15",
              "checkout": "2025-02-20",
              "ne_lat": "25.21",
              "ne_lng": "55.29",
              "sw_lat": "25.18",
              "sw_lng": "55.26",
              "search_by_map": "true",
              "zoom": "14",
              "version": "1.8.3",
              "_format": "for_explore_search_web",
              "items_per_grid": "20",
              "currency": "AED",
              "locale": "en",
              "key": AIRBNB_API_KEY,
              "refinement_paths[]": "/homes",
              "tab_id": "home_tab",
              "category_tag": "Tag:8661",  # Possible Guest Favorites tag
          }
          
          try:
              response = curl_requests.get(
                  "https://www.airbnb.com/api/v2/explore_tabs",
                  params=params,
                  headers=headers,
                  impersonate="chrome120",
                  timeout=30
              )
              print(f"   Status: {response.status_code}")
              if response.status_code == 200:
                  data = response.json()
                  count = sum(len(s.get("listings", [])) for t in data.get("explore_tabs", []) for s in t.get("sections", []))
                  print(f"   RÃ©sultats: {count}")
          except Exception as e:
              print(f"   Erreur: {e}")

          # Test 6: Essayer avec superhost=true pour voir si les filtres marchent
          print("\nðŸ“Š TEST 6: explore_tabs avec superhost=true (test de rÃ©fÃ©rence)")
          print("-" * 40)
          
          params = {
              "checkin": "2025-02-15",
              "checkout": "2025-02-20",
              "ne_lat": "25.21",
              "ne_lng": "55.29",
              "sw_lat": "25.18",
              "sw_lng": "55.26",
              "search_by_map": "true",
              "zoom": "14",
              "version": "1.8.3",
              "_format": "for_explore_search_web",
              "items_per_grid": "20",
              "currency": "AED",
              "locale": "en",
              "key": AIRBNB_API_KEY,
              "refinement_paths[]": "/homes",
              "tab_id": "home_tab",
              "superhost": "true",
          }
          
          try:
              response = curl_requests.get(
                  "https://www.airbnb.com/api/v2/explore_tabs",
                  params=params,
                  headers=headers,
                  impersonate="chrome120",
                  timeout=30
              )
              print(f"   Status: {response.status_code}")
              if response.status_code == 200:
                  data = response.json()
                  count = sum(len(s.get("listings", [])) for t in data.get("explore_tabs", []) for s in t.get("sections", []))
                  print(f"   RÃ©sultats: {count}")
                  
                  # VÃ©rifier si tous sont superhosts
                  superhost_count = 0
                  for tab in data.get("explore_tabs", []):
                      for section in tab.get("sections", []):
                          for listing in section.get("listings", []):
                              if listing.get("listing", {}).get("is_superhost"):
                                  superhost_count += 1
                  print(f"   Superhosts: {superhost_count}/{count}")
          except Exception as e:
              print(f"   Erreur: {e}")

          print("\n" + "=" * 80)
          print("ðŸŽ‰ FIN DES TESTS")
          print("=" * 80)
          EOF
