name: Debug GraphQL StaysSearch

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: pip install curl_cffi
      
      - name: Test GraphQL StaysSearch
        run: |
          python << 'EOF'
          import json
          from curl_cffi import requests as curl_requests

          AIRBNB_API_KEY = "d306zoyjsyarp7ifhu67rjxn52tv0t20"
          GRAPHQL_HASH = "d9ab2c7e443b50fdce5cdcb69d4f7e7626dbab1609c981565a6c4bdbb04546e3"

          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
              "Accept": "*/*",
              "Accept-Language": "en-US,en;q=0.9",
              "Content-Type": "application/json",
              "X-Airbnb-API-Key": AIRBNB_API_KEY,
              "X-Airbnb-GraphQL-Platform": "web",
              "X-Airbnb-GraphQL-Platform-Client": "minimalist-niobe",
              "X-CSRF-Without-Token": "1",
              "Origin": "https://www.airbnb.com",
              "Referer": "https://www.airbnb.com/s/Downtown-Dubai/homes",
          }

          # Payload exact copiÃ© de ta requÃªte (simplifiÃ©)
          raw_params = [
              {"filterName": "cdnCacheSafe", "filterValues": ["false"]},
              {"filterName": "channel", "filterValues": ["EXPLORE"]},
              {"filterName": "checkin", "filterValues": ["2026-02-20"]},
              {"filterName": "checkout", "filterValues": ["2026-02-25"]},
              {"filterName": "datePickerType", "filterValues": ["calendar"]},
              {"filterName": "flexibleTripLengths", "filterValues": ["one_week"]},
              {"filterName": "guestFavorite", "filterValues": ["true"]},
              {"filterName": "itemsPerGrid", "filterValues": ["18"]},
              {"filterName": "placeId", "filterValues": ["ChIJg_kMcC9oXz4RBLnAdrBYzLU"]},
              {"filterName": "priceFilterInputType", "filterValues": ["2"]},
              {"filterName": "priceFilterNumNights", "filterValues": ["5"]},
              {"filterName": "query", "filterValues": ["Downtown Dubai"]},
              {"filterName": "refinementPaths", "filterValues": ["/homes"]},
              {"filterName": "screenSize", "filterValues": ["large"]},
              {"filterName": "searchMode", "filterValues": ["regular_search"]},
              {"filterName": "selectedFilterOrder", "filterValues": ["guest_favorite:true"]},
              {"filterName": "tabId", "filterValues": ["home_tab"]},
              {"filterName": "version", "filterValues": ["1.8.3"]},
          ]

          treatment_flags = [
              "feed_map_decouple_m11_treatment",
              "recommended_amenities_2024_treatment_b",
              "filter_redesign_2024_treatment",
              "filter_reordering_2024_roomtype_treatment",
              "p2_category_bar_removal_treatment",
              "selected_filters_2024_treatment",
              "recommended_filters_2024_treatment_b",
              "m13_search_input_phase2_treatment",
              "m13_search_input_services_enabled"
          ]

          search_request = {
              "metadataOnly": False,
              "requestedPageType": "STAYS_SEARCH",
              "searchType": "filter_change",
              "treatmentFlags": treatment_flags,
              "maxMapItems": 9999,
              "rawParams": raw_params
          }

          payload = {
              "operationName": "StaysSearch",
              "variables": {
                  "staysSearchRequest": search_request,
                  "staysMapSearchRequestV2": search_request.copy(),
                  "isLeanTreatment": False,
                  "aiSearchEnabled": False,
                  "skipExtendedSearchParams": False
              },
              "extensions": {
                  "persistedQuery": {
                      "version": 1,
                      "sha256Hash": GRAPHQL_HASH
                  }
              }
          }

          print("=" * 80)
          print("ðŸ” TEST GRAPHQL STAYS SEARCH")
          print("=" * 80)
          
          print("\nðŸ“¤ Payload envoyÃ©:")
          print(json.dumps(payload, indent=2)[:2000])
          
          print("\n" + "-" * 40)
          print("ðŸ“¡ Envoi de la requÃªte...")
          
          try:
              response = curl_requests.post(
                  f"https://www.airbnb.com/api/v3/StaysSearch/{GRAPHQL_HASH}?operationName=StaysSearch&locale=en&currency=AED",
                  headers=headers,
                  json=payload,
                  impersonate="chrome120",
                  timeout=30
              )
              
              print(f"\nðŸ“Š Status: {response.status_code}")
              
              data = response.json()
              
              if "errors" in data:
                  print(f"\nâŒ ERREURS GraphQL:")
                  print(json.dumps(data["errors"], indent=2))
              else:
                  print(f"\nâœ… SuccÃ¨s!")
                  
                  # Explorer la structure
                  print("\nðŸ“‚ STRUCTURE DE LA RÃ‰PONSE:")
                  
                  def explore_structure(obj, prefix="", depth=0):
                      if depth > 4:
                          return
                      if isinstance(obj, dict):
                          for key in list(obj.keys())[:15]:
                              val = obj[key]
                              if isinstance(val, dict):
                                  print(f"{prefix}{key}: {{...}} ({len(val)} keys)")
                                  explore_structure(val, prefix + "  ", depth + 1)
                              elif isinstance(val, list):
                                  print(f"{prefix}{key}: [...] ({len(val)} items)")
                                  if val and depth < 3:
                                      explore_structure(val[0], prefix + "  [0].", depth + 1)
                              else:
                                  val_str = str(val)[:50] if val else "None"
                                  print(f"{prefix}{key}: {val_str}")
                  
                  explore_structure(data)
                  
                  # Chercher les listings dans diffÃ©rents chemins possibles
                  print("\n" + "-" * 40)
                  print("ðŸ” RECHERCHE DES LISTINGS:")
                  
                  stays_search = data.get("data", {}).get("presentation", {}).get("staysSearch", {})
                  results = stays_search.get("results", {})
                  search_results = results.get("searchResults", [])
                  
                  print(f"   searchResults count: {len(search_results)}")
                  
                  if search_results:
                      print(f"\n   Premier rÃ©sultat (clÃ©s): {list(search_results[0].keys())}")
                      print(f"\n   Premier rÃ©sultat complet:")
                      print(json.dumps(search_results[0], indent=2, default=str)[:3000])
                  
          except Exception as e:
              print(f"\nâŒ Exception: {e}")
              import traceback
              traceback.print_exc()

          print("\n" + "=" * 80)
          print("ðŸŽ‰ FIN DU TEST")
          print("=" * 80)
          EOF
