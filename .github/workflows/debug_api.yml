name: Debug Compare Requests

on:
  workflow_dispatch:
    inputs:
      place_id:
        description: 'Place ID (ex: ChIJg_kMcC9oXz4RBLnAdrBYzLU)'
        required: true
        default: 'ChIJg_kMcC9oXz4RBLnAdrBYzLU'
      query:
        description: 'Query text (ex: Downtown Dubai)'
        required: true
        default: 'Downtown Dubai'

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: pip install curl_cffi
      
      - name: Compare requests
        env:
          PLACE_ID: ${{ inputs.place_id }}
          QUERY: ${{ inputs.query }}
        run: |
          python << 'EOF'
          import json
          import os
          from curl_cffi import requests as curl_requests

          AIRBNB_API_KEY = "d306zoyjsyarp7ifhu67rjxn52tv0t20"
          GRAPHQL_HASH = "d9ab2c7e443b50fdce5cdcb69d4f7e7626dbab1609c981565a6c4bdbb04546e3"
          
          PLACE_ID = os.environ.get("PLACE_ID", "ChIJg_kMcC9oXz4RBLnAdrBYzLU")
          QUERY = os.environ.get("QUERY", "Downtown Dubai")

          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
              "Accept": "*/*",
              "Accept-Language": "en-US,en;q=0.9",
              "Content-Type": "application/json",
              "X-Airbnb-API-Key": AIRBNB_API_KEY,
              "X-Airbnb-GraphQL-Platform": "web",
              "X-Airbnb-GraphQL-Platform-Client": "minimalist-niobe",
              "X-CSRF-Without-Token": "1",
              "Origin": "https://www.airbnb.com",
              "Referer": "https://www.airbnb.com/s/Downtown-Dubai/homes",
          }

          def test_request(name, raw_params):
              """Teste une requÃªte GraphQL et affiche le rÃ©sultat."""
              print(f"\n{'='*60}")
              print(f"ðŸ§ª TEST: {name}")
              print(f"{'='*60}")
              
              treatment_flags = [
                  "feed_map_decouple_m11_treatment",
                  "recommended_amenities_2024_treatment_b",
                  "filter_redesign_2024_treatment",
                  "filter_reordering_2024_roomtype_treatment",
                  "p2_category_bar_removal_treatment",
                  "selected_filters_2024_treatment",
                  "recommended_filters_2024_treatment_b",
                  "m13_search_input_phase2_treatment",
                  "m13_search_input_services_enabled"
              ]
              
              search_request = {
                  "metadataOnly": False,
                  "requestedPageType": "STAYS_SEARCH",
                  "searchType": "filter_change",
                  "treatmentFlags": treatment_flags,
                  "maxMapItems": 9999,
                  "rawParams": raw_params
              }
              
              payload = {
                  "operationName": "StaysSearch",
                  "variables": {
                      "staysSearchRequest": search_request,
                      "staysMapSearchRequestV2": search_request.copy(),
                      "isLeanTreatment": False,
                      "aiSearchEnabled": False,
                      "skipExtendedSearchParams": False
                  },
                  "extensions": {
                      "persistedQuery": {
                          "version": 1,
                          "sha256Hash": GRAPHQL_HASH
                      }
                  }
              }
              
              # Afficher les paramÃ¨tres clÃ©s
              print("\nðŸ“¤ rawParams clÃ©s:")
              for p in raw_params:
                  print(f"   {p['filterName']}: {p['filterValues']}")
              
              try:
                  response = curl_requests.post(
                      f"https://www.airbnb.com/api/v3/StaysSearch/{GRAPHQL_HASH}?operationName=StaysSearch&locale=en&currency=AED",
                      headers=headers,
                      json=payload,
                      impersonate="chrome120",
                      timeout=30
                  )
                  
                  print(f"\nðŸ“Š Status: {response.status_code}")
                  
                  data = response.json()
                  
                  if "errors" in data:
                      print(f"âŒ ERREUR: {data['errors'][0].get('message', 'Unknown')}")
                      print(f"   Details: {json.dumps(data['errors'][0].get('extensions', {}), indent=2)[:500]}")
                      return 0
                  else:
                      stays_search = data.get("data", {}).get("presentation", {}).get("staysSearch", {})
                      results = stays_search.get("results", {})
                      search_results = results.get("searchResults", [])
                      print(f"âœ… SUCCÃˆS: {len(search_results)} listings trouvÃ©s")
                      
                      if search_results:
                          first = search_results[0]
                          print(f"\n   Premier rÃ©sultat - EXPLORATION PROFONDE:")
                          
                          # Chercher l'ID partout
                          print(f"\n   TOP LEVEL:")
                          for key in first.keys():
                              val = first.get(key)
                              if val is None:
                                  print(f"   - {key}: None")
                              elif isinstance(val, dict):
                                  print(f"   - {key}: {{dict with {len(val)} keys}}")
                              elif isinstance(val, list):
                                  print(f"   - {key}: [list with {len(val)} items]")
                              else:
                                  print(f"   - {key}: {str(val)[:60]}")
                          
                          # Explorer listing nested
                          print(f"\n   NESTED OBJECTS:")
                          
                          # demandStayListing
                          dsl = first.get("demandStayListing", {})
                          if dsl:
                              print(f"   demandStayListing keys: {list(dsl.keys())[:10]}")
                              print(f"   demandStayListing.id: {dsl.get('id')}")
                              print(f"   demandStayListing.listingId: {dsl.get('listingId')}")
                          
                          # structuredContent
                          sc = first.get("structuredContent", {})
                          if sc:
                              print(f"   structuredContent keys: {list(sc.keys())[:10]}")
                          
                          # contextualPictures - peut contenir l'ID
                          cp = first.get("contextualPictures", [])
                          if cp:
                              print(f"   contextualPictures[0]: {cp[0] if cp else 'empty'}")
                          
                          # passportData
                          pd = first.get("passportData", {})
                          if pd:
                              print(f"   passportData keys: {list(pd.keys())[:10]}")
                              print(f"   passportData.listingId: {pd.get('listingId')}")
                              print(f"   passportData.id: {pd.get('id')}")
                              
                      return len(search_results)
                      
              except Exception as e:
                  print(f"âŒ Exception: {e}")
                  return 0

          print("="*60)
          print("ðŸ” COMPARAISON DES REQUÃŠTES GRAPHQL")
          print("="*60)
          print(f"\nPlace ID: {PLACE_ID}")
          print(f"Query: {QUERY}")

          # ============================================================
          # TEST 1: Payload EXACT copiÃ© du navigateur (qui fonctionne)
          # ============================================================
          params_exact = [
              {"filterName": "cdnCacheSafe", "filterValues": ["false"]},
              {"filterName": "channel", "filterValues": ["EXPLORE"]},
              {"filterName": "checkin", "filterValues": ["2026-02-20"]},
              {"filterName": "checkout", "filterValues": ["2026-02-25"]},
              {"filterName": "datePickerType", "filterValues": ["calendar"]},
              {"filterName": "flexibleTripLengths", "filterValues": ["one_week"]},
              {"filterName": "guestFavorite", "filterValues": ["true"]},
              {"filterName": "itemsPerGrid", "filterValues": ["18"]},
              {"filterName": "placeId", "filterValues": [PLACE_ID]},
              {"filterName": "priceFilterInputType", "filterValues": ["2"]},
              {"filterName": "priceFilterNumNights", "filterValues": ["5"]},
              {"filterName": "query", "filterValues": [QUERY]},
              {"filterName": "refinementPaths", "filterValues": ["/homes"]},
              {"filterName": "screenSize", "filterValues": ["large"]},
              {"filterName": "searchMode", "filterValues": ["regular_search"]},
              {"filterName": "selectedFilterOrder", "filterValues": ["guest_favorite:true"]},
              {"filterName": "tabId", "filterValues": ["home_tab"]},
              {"filterName": "version", "filterValues": ["1.8.3"]},
          ]
          test_request("EXACT (copiÃ© du navigateur)", params_exact)

          # ============================================================
          # TEST 2: Sans placeId (seulement query)
          # ============================================================
          params_no_placeid = [
              {"filterName": "cdnCacheSafe", "filterValues": ["false"]},
              {"filterName": "channel", "filterValues": ["EXPLORE"]},
              {"filterName": "checkin", "filterValues": ["2026-02-20"]},
              {"filterName": "checkout", "filterValues": ["2026-02-25"]},
              {"filterName": "datePickerType", "filterValues": ["calendar"]},
              {"filterName": "flexibleTripLengths", "filterValues": ["one_week"]},
              {"filterName": "guestFavorite", "filterValues": ["true"]},
              {"filterName": "itemsPerGrid", "filterValues": ["50"]},
              {"filterName": "query", "filterValues": [QUERY]},
              {"filterName": "refinementPaths", "filterValues": ["/homes"]},
              {"filterName": "screenSize", "filterValues": ["large"]},
              {"filterName": "searchMode", "filterValues": ["regular_search"]},
              {"filterName": "selectedFilterOrder", "filterValues": ["guest_favorite:true"]},
              {"filterName": "tabId", "filterValues": ["home_tab"]},
              {"filterName": "version", "filterValues": ["1.8.3"]},
          ]
          test_request("Sans placeId (query seul)", params_no_placeid)

          # ============================================================
          # TEST 3: Avec bounding box au lieu de query
          # ============================================================
          params_bbox = [
              {"filterName": "cdnCacheSafe", "filterValues": ["false"]},
              {"filterName": "channel", "filterValues": ["EXPLORE"]},
              {"filterName": "checkin", "filterValues": ["2026-02-20"]},
              {"filterName": "checkout", "filterValues": ["2026-02-25"]},
              {"filterName": "datePickerType", "filterValues": ["calendar"]},
              {"filterName": "flexibleTripLengths", "filterValues": ["one_week"]},
              {"filterName": "guestFavorite", "filterValues": ["true"]},
              {"filterName": "itemsPerGrid", "filterValues": ["50"]},
              {"filterName": "neLat", "filterValues": ["25.208047"]},
              {"filterName": "neLng", "filterValues": ["55.286305"]},
              {"filterName": "swLat", "filterValues": ["25.181020"]},
              {"filterName": "swLng", "filterValues": ["55.256437"]},
              {"filterName": "searchByMap", "filterValues": ["true"]},
              {"filterName": "refinementPaths", "filterValues": ["/homes"]},
              {"filterName": "screenSize", "filterValues": ["large"]},
              {"filterName": "searchMode", "filterValues": ["regular_search"]},
              {"filterName": "selectedFilterOrder", "filterValues": ["guest_favorite:true"]},
              {"filterName": "tabId", "filterValues": ["home_tab"]},
              {"filterName": "version", "filterValues": ["1.8.3"]},
          ]
          test_request("Avec bounding box", params_bbox)

          # ============================================================
          # TEST 4: placeId + query SANS guestFavorite
          # ============================================================
          params_no_gf = [
              {"filterName": "cdnCacheSafe", "filterValues": ["false"]},
              {"filterName": "channel", "filterValues": ["EXPLORE"]},
              {"filterName": "checkin", "filterValues": ["2026-02-20"]},
              {"filterName": "checkout", "filterValues": ["2026-02-25"]},
              {"filterName": "datePickerType", "filterValues": ["calendar"]},
              {"filterName": "flexibleTripLengths", "filterValues": ["one_week"]},
              {"filterName": "itemsPerGrid", "filterValues": ["50"]},
              {"filterName": "placeId", "filterValues": [PLACE_ID]},
              {"filterName": "query", "filterValues": [QUERY]},
              {"filterName": "refinementPaths", "filterValues": ["/homes"]},
              {"filterName": "screenSize", "filterValues": ["large"]},
              {"filterName": "searchMode", "filterValues": ["regular_search"]},
              {"filterName": "tabId", "filterValues": ["home_tab"]},
              {"filterName": "version", "filterValues": ["1.8.3"]},
          ]
          test_request("placeId + query SANS guestFavorite", params_no_gf)

          # ============================================================
          # TEST 5: Minimal avec placeId + guestFavorite
          # ============================================================
          params_minimal = [
              {"filterName": "checkin", "filterValues": ["2026-02-20"]},
              {"filterName": "checkout", "filterValues": ["2026-02-25"]},
              {"filterName": "guestFavorite", "filterValues": ["true"]},
              {"filterName": "itemsPerGrid", "filterValues": ["50"]},
              {"filterName": "placeId", "filterValues": [PLACE_ID]},
              {"filterName": "query", "filterValues": [QUERY]},
              {"filterName": "refinementPaths", "filterValues": ["/homes"]},
              {"filterName": "tabId", "filterValues": ["home_tab"]},
          ]
          test_request("MINIMAL (placeId + query + guestFavorite)", params_minimal)

          print("\n" + "="*60)
          print("ðŸŽ‰ FIN DES TESTS")
          print("="*60)
          EOF
